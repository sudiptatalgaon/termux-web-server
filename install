#!$PREFIX/bin/bash

pkg update -y
DEBIAN_FRONTEND=noninteractive pkg upgrade -y -o Dpkg::Options::="--force-confold"

# Request permission if not granted
if [ ! -r /sdcard ]; then
  echo "Requesting storage permission..."
  termux-setup-storage
fi

# Wait until permission is granted
TIMEOUT=30
COUNT=0
until [ -r /sdcard ]; do
  sleep 1
  COUNT=$((COUNT+1))
  if [ $COUNT -ge $TIMEOUT ]; then
    echo "Storage permission denied or timed out"
    exit 1
  fi
done
echo "Storage permission granted."

pkg install apache2 php php-apache mariadb phpmyadmin nodejs cloudflared -y
npm install -g pm2

if [ ! -d /sdcard/htdocs ]; then
  mkdir /sdcard/htdocs
fi
if [ ! -d $PREFIX/etc/php ]; then
  mkdir $PREFIX/etc/php
fi
if [ ! -e $PREFIX/etc/php/php.ini ]; then
  cp termux-web-server/php.ini $PREFIX/etc/php/
fi
if [ ! -e /sdcard/htdocs/index.php ]; then
  cp termux-web-server/index.php /sdcard/htdocs/
fi

rm $PREFIX/etc/apache2/httpd.conf

cp termux-web-server/httpd.conf $PREFIX/etc/apache2/

if [ -e $PREFIX/bin/starjet ]; then
  rm $PREFIX/bin/starjet
fi

cp termux-web-server/starjet $PREFIX/bin/

chmod +x $PREFIX/bin/starjet

# Generate passwords
SECRET=$(tr -dc 'a-z0-9' </dev/urandom | head -c 32)
ROOTPW=$(tr -dc 'A-Za-z0-9' </dev/urandom | head -c 16)
PMAPW=$(tr -dc 'A-Za-z0-9' </dev/urandom | head -c 16)

# Start MariaDB
mariadbd-safe &
sleep 2
# Wait until MariaDB is ready
echo "Waiting for MariaDB to start..."
until mariadb-admin ping --silent; do
  sleep 1
done
echo "MariaDB is ready."

# Configure MariaDB
echo "Configure MariaDB"
mariadb -u root <<EOF
DROP USER IF EXISTS 'root'@'127.0.0.1';
DROP USER IF EXISTS 'root'@'::1';
ALTER USER 'root'@'localhost' IDENTIFIED BY '$ROOTPW';
CREATE DATABASE IF NOT EXISTS phpmyadmin;
CREATE USER IF NOT EXISTS 'pma'@'localhost' IDENTIFIED BY '$PMAPW';
GRANT SELECT, INSERT, UPDATE, DELETE ON phpmyadmin.* TO 'pma'@'localhost';
FLUSH PRIVILEGES;
EOF

# Import PhpMyAdmin tables
echo "Import PhpMyAdmin tables"
mariadb -u root -p"$ROOTPW" phpmyadmin \
< $PREFIX/share/phpmyadmin/sql/create_tables.sql

# Configure config.inc.php
echo "Configure config.inc.php"
sed -i "s|^\$cfg\['blowfish_secret'\].*|\$cfg['blowfish_secret'] = '$SECRET';|" \
$PREFIX/share/phpmyadmin/config.inc.php
grep -q "^\$cfg\['CookieSameSite'\]" $PREFIX/share/phpmyadmin/config.inc.php || \
sed -i "/\['auth_type'\] = 'cookie';/a\\
\$cfg['CookieSameSite'] = 'Strict';
" $PREFIX/share/phpmyadmin/config.inc.php
grep -q "^\$cfg\['Servers'\].*\['socket'\]" $PREFIX/share/phpmyadmin/config.inc.php || \
sed -i "/\['host'\] = 'localhost';/a\\\$cfg['Servers'][\$i]['socket'] = '$PREFIX/var/run/mysqld.sock';" \
$PREFIX/share/phpmyadmin/config.inc.php
sed -i 's|^// \(\$cfg\['\''Servers'\''\]\[\$i\].*\)|\1|' \
$PREFIX/share/phpmyadmin/config.inc.php
sed -i 's|^$cfg\['\''Servers'\''\]\[$i\]\['\''controlhost'\''\].*|// &|' \
$PREFIX/share/phpmyadmin/config.inc.php
sed -i 's|^$cfg\['\''Servers'\''\]\[$i\]\['\''controlport'\''\].*|// &|' \
$PREFIX/share/phpmyadmin/config.inc.php
sed -i "s|\(\$cfg\['Servers'\]\[\$i\]\['controlpass'\][[:space:]]*=[[:space:]]*\).*$|\1'$PMAPW';|" \
$PREFIX/share/phpmyadmin/config.inc.php

echo "Blowfish Secret: $SECRET"
echo "MariaDB root password: $ROOTPW"
echo "PhpMyAdmin pma password: $PMAPW"
echo "Web server installed sucussfully..."
echo "Place your php files in /sdcard/htdocs"
echo "Use command for next start: starjet"
echo "Starting web server"

starjet start

echo "Running Web Server"

termux-open-url http://localhost:8080/
